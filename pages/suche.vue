<template lang="pug">
  v-container
    h1 Suche
    v-text-field(v-model="suche" label="Suche...")

    template(v-if="suche")
      h2 Blog
      v-row(v-if="posts.length > 0")
        v-col(cols="12" sm="6" md="4" v-for="item in posts" :key="item.slug")
          v-card(tile hover outlined @click="$router.push(`/blog/${item.slug}`)")
            ec-image-item(:image="item.featuredImage" :title="item.title" :subTitle="`Vom ${item.published.split('T')[0].split('-').reverse().join('.')}`")
      p(v-else) Keine Suchergebnisse gefunden!
      
      h2 Veranstaltungen
      v-row(v-if="veranstaltungen.length > 0")
        v-col(cols="12" sm="6" md="4" v-for="item in veranstaltungen" :key="item.slug")
          v-card(tile hover outlined @click="$router.push(`/veranstaltungen/${item.slug}`)")
            ec-image-item(:image="item.featuredImage" :title="item.title" :subTitle="`Vom ${item.begin.split('-').reverse().join('.')} bis ${item.ende.split('-').reverse().join('.')}`")
      p(v-else) Keine Suchergebnisse gefunden!
    p(v-else) Gebe einen Suchbegriff ein.
</template>
<script lang="ts">
import {
  defineComponent,
  ref,
  useContext,
  watch,
} from '@nuxtjs/composition-api'

export default defineComponent({
  setup() {
    const suche = ref('')
    const posts = ref([])
    const veranstaltungen = ref([])

    const { $content } = useContext()

    watch(suche, async () => {
      const [v, p] = await Promise.all([
        $content('veranstaltung')
          .only(['slug', 'title', 'begin', 'ende', 'featuredImage', 'tags'])
          .sortBy('begin')
          .search(suche.value)
          .limit(3)
          .fetch(),
        $content('blog')
          .only([
            'title',
            'tags',
            'description',
            'featuredImage',
            'slug',
            'published',
          ])
          .sortBy('published', 'desc')
          .search(suche.value)
          .limit(6)
          .fetch(),
      ])

      posts.value = p
      veranstaltungen.value = v
    })

    return {
      suche,
      posts,
      veranstaltungen,
    }
  },
})
</script>
